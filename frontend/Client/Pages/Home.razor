@page "/"
@inject HttpClient HttpClient
@using System.Text.Json
@using System.Text.Json.Serialization

<PageTitle>Home</PageTitle>
<img src="/images/logo.png" alt="logo" style="height:140px" />
<hr/>

<style>
    .current-weather {
        background-color: #f0f0f0;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
    }

    .current-weather h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
    }

    .current-weather img {
        width: 50px;
        height: 50px;
    }

    .current-weather ul {
        list-style-type: none;
        padding-left: 0;
    }

    .current-weather ul li {
        margin-bottom: 5px;
    }

    .weather-table {
        border: 1px solid #000;
        border-collapse: collapse;
        width: 100%;
    }

    .weather-table th, .weather-table td {
        border: 1px solid #000;
        padding: 8px;
        text-align: left;
    }

    .weather-table th {
        background-color: #f0f0f0;
    }
</style>

<div>
    Selecciona tu ciudad:
    <select id="citySelector" @onchange="OnCityChanged">
        <option value="GUA">Ciudad de Guatemala</option>
        @foreach (var city in cities)
        {
            <option value="@city.CityCode">@city.CityName</option>
        }
    </select>
</div>

<div class="current-weather">
    @if (weatherData != null && weatherData.Count > 0)
    {
        var currentWeather = weatherData.First(); // Assuming first item is current weather
        <div>
            <h3>Condiciones actuales (@currentWeather.CollectionDate.ToString("yyyy-MM-dd hh:mm:ss tt"))</h3>
            <p>@currentWeather.Weather_Description</p>
            <img src="/images/icons/@currentWeather.Weather_Icon" alt="Icon" />
            <ul>
                <li>Temperatura: @(Math.Round(currentWeather.Main_Temp - 273.15, 2)) °C</li>
                <li>Sensación Térmica: @(Math.Round(currentWeather.Main_Feels_Like - 273.15, 2)) °C</li>
                <li>Presión: @currentWeather.Main_Pressure hPa</li>
                <li>Humedad: @currentWeather.Main_Humidity %</li>
                <li>Temp Mínima: @(Math.Round(currentWeather.Main_Temp_Min - 273.15, 2)) °C</li>
                <li>Temp Máxima: @(Math.Round(currentWeather.Main_Temp_Max - 273.15, 2)) °C</li>
                <li>Visibilidad: @currentWeather.Visibility m</li>
                <li>Velocidad del Viento: @currentWeather.Wind_Speed m/s</li>
                <li>Dirección del Viento: @currentWeather.Wind_Deg °</li>
                <li>Nubosidad: @currentWeather.Clouds_All %</li>
                <li>Lluvia (1h): @currentWeather.Rain_1h</li>
            </ul>
        </div>
    }
    else
    {
        <p><em>No hay información disponible para esta ciudad.</em></p>
    }
</div>

@if (weatherData != null && weatherData.Count > 1)
{
    <div class="weather-table">
        <table>
            <thead>
                <tr>
                    <th>Descripción del Clima</th>
                    <th>Icono</th>
                    <th>Temperatura</th>
                    <th>Sensación Térmica</th>
                    <th>Presión</th>
                    <th>Humedad</th>
                    <th>Temp Mínima</th>
                    <th>Temp Máxima</th>
                    <th>Visibilidad</th>
                    <th>Velocidad del Viento</th>
                    <th>Dirección del Viento</th>
                    <th>Nubosidad</th>
                    <th>Lluvia (1h)</th>
                    <th>Fecha de Recolección</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var weather in weatherData.Skip(1)) // Skip first item
                {
                    <tr>
                      <td>@weather.Weather_Description</td>
                      <td><img src="/images/icons/@weather.Weather_Icon" alt="Icon" /></td>
                      <td>@(Math.Round(weather.Main_Temp - 273.15, 2)) °C</td>
                      <td>@(Math.Round(weather.Main_Feels_Like - 273.15, 2)) °C</td>
                      <td>@weather.Main_Pressure hPa</td>
                      <td>@weather.Main_Humidity %</td>
                      <td>@(Math.Round(weather.Main_Temp_Min - 273.15, 2)) °C</td>
                      <td>@(Math.Round(weather.Main_Temp_Max - 273.15, 2)) °C</td>
                      <td>@weather.Visibility m</td>
                      <td>@weather.Wind_Speed m/s</td>
                      <td>@weather.Wind_Deg °</td>
                      <td>@weather.Clouds_All %</td>
                      <td>@weather.Rain_1h</td>
                      <td>@weather.CollectionDate.ToString("yyyy-MM-dd hh:mm:ss tt")</td>
                    </tr>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<City> cities;
    private List<Weather> weatherData;
    private string selectedCityCode = "GUA"; // Default city code

    protected override async Task OnInitializedAsync()
    {
        cities = await GetCitiesAsync();
        await GetWeatherDataAsync(selectedCityCode);
    }

    private async Task<List<City>> GetCitiesAsync()
    {
        var response = await HttpClient.GetFromJsonAsync<ApiResponse>("/data-api/rest/GetCities");
        return response?.Value ?? new List<City>();
    }

    private async Task GetWeatherDataAsync(string cityCode)
    {
        try
        {
            var response = await HttpClient.GetFromJsonAsync<WeatherResponse>($"/data-api/rest/GetWeatherCity?CityCode={cityCode}");
            weatherData = response?.Value ?? new List<Weather>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching weather data: {ex.Message}");
            weatherData = new List<Weather>(); // Handle error gracefully
        }
    }

    private async Task OnCityChanged(ChangeEventArgs e)
    {
        selectedCityCode = e.Value.ToString();
        await GetWeatherDataAsync(selectedCityCode);
    }

    public class ApiResponse
    {
        public List<City> Value { get; set; }
    }

    public class City
    {
        public string CityCode { get; set; }
        public string CityName { get; set; }
    }

    public class WeatherResponse
    {
        public List<Weather> Value { get; set; }
    }

    public class Weather
    {
        public string Name { get; set; }
        public string Weather_Description { get; set; }
        public string Weather_Icon { get; set; }
        public double Main_Temp { get; set; }
        public double Main_Feels_Like { get; set; }
        public int Main_Pressure { get; set; }
        public int Main_Humidity { get; set; }
        public double Main_Temp_Min { get; set; }
        public double Main_Temp_Max { get; set; }
        public int? Main_Sea_Level { get; set; }
        public int? Main_Grnd_Level { get; set; }
        public int Visibility { get; set; }
        public double Wind_Speed { get; set; }
        public int Wind_Deg { get; set; }
        public double? Wind_Gust { get; set; }
        public int Clouds_All { get; set; }
        public string Rain_1h { get; set; }
        public string Rain_3h { get; set; }
        public DateTime CollectionDate { get; set; }
        public DateTime SunriseDate { get; set; }
        public DateTime SunsetDate { get; set; }
    }
}
