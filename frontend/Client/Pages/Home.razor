@page "/"
@inject HttpClient HttpClient
@using System.Text.Json
@using System.Text.Json.Serialization

<PageTitle>Home</PageTitle>
<img src="/images/logo.png" alt="logo" style="height:140px" />
<hr/>

<style>
    .current-weather {
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #a8a8a8;
    }

    .current-w    private async Task GetPollutionDataAsync(string cityCode)
    {
        isLoadingPollution = true;
        try
        {
            // Use the correct GetLatestAirQuality endpoint
            var response = await HttpClient.GetFromJsonAsync<PollutionResponse>($"/data-api/rest/GetLatestAirQuality?CityCode={cityCode}");
            pollutionData = response?.Value?.FirstOrDefault();
        }
        catch
        {
            // Graceful fallback if endpoint isn't available yet
            pollutionData = null;
        }
        finally
        {
            isLoadingPollution = false;
        }
    }

    private string GetAqiColor(int aqi)
    {
        return aqi switch
        {
            1 => "linear-gradient(135deg, #4CAF50, #66BB6A)", // Good - Green
            2 => "linear-gradient(135deg, #FFC107, #FFD54F)", // Fair - Yellow
            3 => "linear-gradient(135deg, #FF9800, #FFB74D)", // Moderate - Orange
            4 => "linear-gradient(135deg, #F44336, #EF5350)", // Poor - Red
            5 => "linear-gradient(135deg, #9C27B0, #BA68C8)", // Very Poor - Purple
            _ => "linear-gradient(135deg, #9E9E9E, #BDBDBD)"  // Unknown - Gray
        };
    } padding: 1px;
        vertical-align: middle;
        text-align: left;
        font-size: 0.8rem;
    }

    .weather-table img {
        width: 50px;
        height: 50px;
    }

    .current-weather ul {
        list-style-type: none;
        padding-left: 0;
    }

    .current-weather ul li {
        margin-bottom: 5px;
    }

    .weather-table {
        font-size: 0.75rem;
    }

    .weather-table th, .weather-table td {
        border: 1px solid #a8a8a8;
        padding: 5px;
        text-align: left;
    }

    .weather-table th {
        background-color: #f0f0f0;
    }

    /* Spinner CSS moved to app.css for compatibility */
</style>

<div>
    Selecciona tu ciudad:
    @if (isLoadingCities)
    {
       <div style="text-align:center; margin:20px;">
    <svg class="loading-progress" width="32" height="32" viewBox="0 0 32 32">
        <!-- Grey background circle -->
        <circle cx="16" cy="16" r="11" stroke="#e0e0e0" stroke-width="1" fill="none" />
        <g>
            <animateTransform
                attributeName="transform"
                type="rotate"
                from="0 16 16"
                to="360 16 16"
                dur="1s"
                repeatCount="indefinite" />
            <!-- Only a partial blue arc, not a full ring -->
            <circle
                cx="16"
                cy="16"
                r="11"
                stroke="#1b6ec2"
                stroke-width="1"
                fill="none"
                stroke-dasharray="17 52"
                stroke-dashoffset="60"
                stroke-linecap="round"
                transform="rotate(-90 16 16)" />
        </g>
    </svg>
    <div>Cargando ciudades...</div>
</div>

    }
    else
    {
        <select id="citySelector" @onchange="OnCityChanged">
            <option value="GUA">Ciudad de Guatemala</option>
            @foreach (var city in cities)
            {
                <option value="@city.CityCode">@city.CityName</option>
            }
        </select>
    }
</div>
<br/>

    @if (weatherData != null && weatherData.Count > 0)
    {
        var currentWeather = weatherData.First(); 
        <div class="current-weather" style="background-image: linear-gradient(to bottom, @currentWeather.Start_Color, @currentWeather.End_Color);">
                Condiciones para <strong>@currentWeather.Name</strong><br/>
                <em>Ultima lectura: @currentWeather.CollectionDate.ToString("yyyy-MM-dd hh:mm tt")</em>
                <br/>
                <table>
                <tr>
                    <td>
                        <div style="border-radius:10px;border: 1px solid #afafaf; padding:10px; vertical-align: middle; text-align: center;">
                            <img src="/images/icons/@currentWeather.Weather_Icon" alt="Icon" /><br/>
                            <strong>@currentWeather.Weather_Description</strong> 
                        </div>
                    </td>
                    <td style="padding:10px;text-align: left;">
                    <br/>
                    <ul>
                        <li><strong>Temperatura:</strong> @currentWeather.Main_Temp °C</li>
                        <li><strong>Sensación Térmica:</strong> @currentWeather.Main_Feels_Like °C</li>
                        <li><strong>Presión:</strong> @currentWeather.Main_Pressure hPa</li>
                        <li><strong>Visibilidad:</strong> @currentWeather.Visibility m</li>
                        <li><strong>Nubosidad:</strong> @currentWeather.Clouds_All%</li>
                        <li><strong>Lluvia (1h):</strong> @currentWeather.Rain_1h mm</li>
                    </ul>
                    </td>
                </tr>
                </table>
        </div>
        <br/>
        <div class="current-weather" style="background-image: linear-gradient(to bottom, #FDB949, #ffe1c3);">
            <table>
                <tr>Info <strong>@currentWeather.Name</strong></tr>
                <tr style="text-align: left; padding: 0px;">
                    <td><img src="/images/icons/tlow.png" alt="temp low" style="height:60px;" />@currentWeather.Main_Temp_Min °C</td>
                    <td><img src="/images/icons/thigh.png" alt="temp high" style="height:60px;" />@currentWeather.Main_Temp_Max °C</td>
                </tr>
                <tr style="text-align: left; padding: 0px;">
                    <td><img src="/images/icons/humidity.png" alt="humidity" style="height:60px;" />@currentWeather.Main_Humidity%</td>
                    <td><img src="/images/icons/wind.png" alt="wind" style="height:50px;" />@currentWeather.Wind_Speed m/s | @currentWeather.Wind_Deg°</td>
                </tr>
                <tr style="text-align: left; padding: 0px;">
                    <td><img src="/images/icons/sunrise.png" alt="sunrise" style="height:60px;" />@currentWeather.SunriseDate.ToString("hh:mm tt")</td>
                    <td><img src="/images/icons/sunset.png" alt="sunset" style="height:60px;" />@currentWeather.SunsetDate.ToString("hh:mm tt")</td>
                </tr>
            </table>
        </div>
    }
    else
    {
        <p><em>Cargando informacion...</em></p>
    }
<br/>


@if (weatherData != null && weatherData.Count > 1)
{
    <ForecastChart CityCode="@selectedCityCode" />
    <br/>
    <strong>Imagen satelital humedad</strong>
    <br/>
    <img class="satellite-img" src="https://imagefilesclimaguate.blob.core.windows.net/mapimages/@selectedCityCode/animation.png" alt="Map"/>
    <br/>

    <!-- Air Pollution Section -->
    <div class="current-weather" style="background-image: linear-gradient(to bottom, #87CEEB, #E0F6FF);">
        <table>
            <tr>
                <td style="vertical-align: middle;">
                    <img src="/images/icons/wind.png" alt="air quality" style="height:50px;" />
                </td>
                <td style="padding-left:10px;">
                    <strong>Calidad del aire - @(pollutionData?.CityName ?? selectedCityCode)</strong><br/>
                    @if (pollutionData?.Date_gt != null)
                    {
                        <em>Última lectura: @pollutionData.Date_gt.ToString("yyyy-MM-dd hh:mm tt")</em>
                    }
                </td>
            </tr>
        </table>
        <hr/>
        @if (isLoadingPollution)
        {
            <div style="text-align:center; margin:20px;">
                <svg class="loading-progress" width="32" height="32" viewBox="0 0 32 32">
                    <circle cx="16" cy="16" r="11" stroke="#e0e0e0" stroke-width="1" fill="none" />
                    <g>
                        <animateTransform attributeName="transform" type="rotate" from="0 16 16" to="360 16 16" dur="1s" repeatCount="indefinite" />
                        <circle cx="16" cy="16" r="11" stroke="#1b6ec2" stroke-width="1" fill="none" stroke-dasharray="17 52" stroke-dashoffset="60" stroke-linecap="round" transform="rotate(-90 16 16)" />
                    </g>
                </svg>
                <div>Cargando calidad del aire...</div>
            </div>
        }
        else if (pollutionData != null)
        {
            <!-- AQI Badge Section -->
            <div style="text-align: center; margin: 15px 0;">
                <div style="display: inline-block; padding: 15px 25px; border-radius: 25px; background: @GetAqiColor(pollutionData.AQI); color: white; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    Índice AQI: @pollutionData.AQI - @pollutionData.Category
                </div>
            </div>

            <!-- Main Pollutants Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
                <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #ddd;">
                    <div style="font-weight: bold; color: #d32f2f;">PM2.5</div>
                    <div style="font-size: 1.2rem; margin: 5px 0;">@pollutionData.PM2_5</div>
                    <div style="font-size: 0.8rem; color: #666;">µg/m³</div>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #ddd;">
                    <div style="font-weight: bold; color: #f57c00;">PM10</div>
                    <div style="font-size: 1.2rem; margin: 5px 0;">@pollutionData.PM10</div>
                    <div style="font-size: 0.8rem; color: #666;">µg/m³</div>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #ddd;">
                    <div style="font-weight: bold; color: #1976d2;">NO₂</div>
                    <div style="font-size: 1.2rem; margin: 5px 0;">@pollutionData.NO2</div>
                    <div style="font-size: 0.8rem; color: #666;">µg/m³</div>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #ddd;">
                    <div style="font-weight: bold; color: #388e3c;">O₃</div>
                    <div style="font-size: 1.2rem; margin: 5px 0;">@pollutionData.O3</div>
                    <div style="font-size: 0.8rem; color: #666;">µg/m³</div>
                </div>
            </div>

            <!-- Additional Pollutants Table -->
            <table style="width: 100%; margin-top: 15px; background: rgba(255,255,255,0.8); border-radius: 8px;">
                <thead>
                    <tr style="background: rgba(255,255,255,0.9);">
                        <th style="padding: 8px; border: 1px solid #ddd; font-size: 0.8rem;">SO₂</th>
                        <th style="padding: 8px; border: 1px solid #ddd; font-size: 0.8rem;">CO</th>
                        <th style="padding: 8px; border: 1px solid #ddd; font-size: 0.8rem;">NO</th>
                        <th style="padding: 8px; border: 1px solid #ddd; font-size: 0.8rem;">NH₃</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 0.9rem;">@pollutionData.SO2</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 0.9rem;">@pollutionData.CO</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 0.9rem;">@pollutionData.NO</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 0.9rem;">@pollutionData.NH3</td>
                    </tr>
                    <tr>
                        <td colspan="4" style="padding: 5px; text-align: center; font-size: 0.75rem; color: #666; border: 1px solid #ddd;">
                            Todas las concentraciones en µg/m³
                        </td>
                    </tr>
                </tbody>
            </table>
        }
        else
        {
            <div style="text-align: center; padding: 20px;">
                <em>No hay datos de calidad del aire disponibles para esta ciudad.</em>
            </div>
        }
    </div>
    <br/>

    <div class="weather-table">
        <strong>Lecturas previas</strong>
        <hr/>
        <table>
            <thead>
                <tr>
                    <th>Fecha lectura</th>
                    <th>Resumen Clima</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var weather in weatherData.Skip(1)) // Skip first item
                {
                    <tr>
                        <td>@weather.CollectionDate.ToString("yyyy-MM-dd hh:mm tt")</td>
                        <td>
                            <img src="/images/icons/@weather.Weather_Icon" alt="Icon" /> @weather.Weather_Description | @weather.Main_Temp °C
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <br/>
    <br/>
}

@code {
    private List<City> cities = new List<City>();
    private List<Weather> weatherData = new List<Weather>();
    private string selectedCityCode = "GUA";
    private bool isLoadingCities = false;
    private bool isLoadingPollution = false;
    private Pollution? pollutionData;

    protected override async Task OnInitializedAsync()
    {
        isLoadingCities = true;
        cities = await GetCitiesAsync();
        isLoadingCities = false;
        await GetWeatherDataAsync(selectedCityCode);
    await GetPollutionDataAsync(selectedCityCode);
    }

    private async Task<List<City>> GetCitiesAsync()
    {
        try
        {
            var response = await HttpClient.GetFromJsonAsync<ApiResponse>("/data-api/rest/GetCities");
            return response?.Value ?? new List<City>();
        }
        catch
        {
            return new List<City>();
        }
    }

    private async Task GetWeatherDataAsync(string cityCode)
    {
        try
        {
            var response = await HttpClient.GetFromJsonAsync<WeatherResponse>($"/data-api/rest/GetWeatherCity?CityCode={cityCode}");
            weatherData = response?.Value ?? new List<Weather>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching weather data: {ex.Message}");
            weatherData = new List<Weather>(); 
        }
    }

    private async Task OnCityChanged(ChangeEventArgs e)
    {
        selectedCityCode = e.Value?.ToString() ?? "GUA";
        await GetWeatherDataAsync(selectedCityCode);
        await GetPollutionDataAsync(selectedCityCode);
    }

    private async Task GetPollutionDataAsync(string cityCode)
    {
        isLoadingPollution = true;
        try
        {
            // Expected Data API endpoint (to be backed by your DB or function)
            var response = await HttpClient.GetFromJsonAsync<PollutionResponse>($"/data-api/rest/GetAirPollution?CityCode={cityCode}");
            pollutionData = response?.Value?.FirstOrDefault();
        }
        catch
        {
            // Graceful fallback if endpoint isn’t available yet
            pollutionData = null;
        }
        finally
        {
            isLoadingPollution = false;
        }
    }

    public class ApiResponse
    {
        public List<City>? Value { get; set; }
    }

    public class City
    {
        public string? CityCode { get; set; }
        public string? CityName { get; set; }
    }

    public class WeatherResponse
    {
        public List<Weather>? Value { get; set; }
    }

    public class PollutionResponse
    {
        public List<Pollution>? Value { get; set; }
    }

    public class Pollution
    {
        public string? CityCode { get; set; }
        public string? CityName { get; set; }
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public int AQI { get; set; }
        public string? Category { get; set; }
        public double CO { get; set; }
        public double NO { get; set; }
        public double NO2 { get; set; }
        public double O3 { get; set; }
        public double SO2 { get; set; }
        public double PM2_5 { get; set; }
        public double PM10 { get; set; }
        public double NH3 { get; set; }
        public DateTime Date_gt { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    public class Weather
    {   
        public string? Name { get; set; }
        public string? Weather_Description { get; set; }
        public string? Weather_Icon { get; set; }
        public double Main_Temp { get; set; }
        public double Main_Feels_Like { get; set; }
        public int Main_Pressure { get; set; }
        public int Main_Humidity { get; set; }
        public double Main_Temp_Min { get; set; }
        public double Main_Temp_Max { get; set; }
        public int? Main_Sea_Level { get; set; }
        public int? Main_Grnd_Level { get; set; }
        public string? Visibility { get; set; }
        public double Wind_Speed { get; set; }
        public int Wind_Deg { get; set; }
        public double? Wind_Gust { get; set; }
        public int Clouds_All { get; set; }
        public string? Rain_1h { get; set; }
        public string? Rain_3h { get; set; }
        public DateTime CollectionDate { get; set; }
        public DateTime SunriseDate { get; set; }
        public DateTime SunsetDate { get; set; }
        public string? Start_Color { get; set; }
        public string? End_Color { get; set; }
    }
}
