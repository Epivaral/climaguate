@* 
    =============================================================================
    CLIMAGUATE - AGRICULTURAL WEATHER INDEX PAGE
    =============================================================================
    This page provides agricultural weather information for Guatemala farmers.
    
    Key Features:
    - City selection for agricultural data
    - Crop suitability information with scores
    - Climate zone and soil type information
    - Agricultural recommendations based on weather conditions
    
    Technical Implementation:
    - Uses Blazor Server with C# code-behind
    - HttpClient for API communication to GetCropsByCity stored procedure
    - Responsive table design for crop data display
    =============================================================================
*@

@page "/agriculture"
@inject HttpClient HttpClient
@using System.Text.Json
@using System.Text.Json.Serialization

<PageTitle>Agricultura - Climaguate</PageTitle>

<!-- Construction/Progress Banner -->
            <div>
                <h6 class="alert-heading mb-1">üöß P√°gina en Construcci√≥n</h6>
                <p class="mb-0" style="font-size:0.85rem; line-height:1.6;">
                    Esta funcionalidad est√° actualmente <strong>en desarrollo</strong>. 
                    Los datos mostrados son <strong>√∫nicamente para demostraci√≥n</strong> y pueden no reflejar 
                    condiciones agr√≠colas reales. Use esta informaci√≥n solo como referencia general.
                </p>
            </div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <img src="/images/logo.png" alt="logo" style="height:80px" />
        <h1 class="d-inline-block ms-3" style="color:#2B4C6F; font-size:1.8rem;">üå± √çndice Agr√≠cola</h1>
    </div>
</div>
<hr/>

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title" style="color:#2B4C6F; font-size:1.1rem;">Informaci√≥n Agr√≠cola por Ciudad</h5>
                <hr style="border-color:#7BCDC8; border-width:2px;"/>
                
                @if (cities != null && cities.Any())
                {
                    <div class="row mb-3" style="font-size:0.85rem; line-height:1.6;">
                        <div class="col-md-6">
                            <label for="citySelect" class="form-label">Seleccionar Ciudad:</label>
                            <select id="citySelect" class="form-select" @onchange="OnCityChanged">
                                <option value="">-- Seleccione una ciudad --</option>
                                @foreach (var city in cities)
                                {
                                    <option value="@city.CityCode">@city.CityName</option>
                                }
                            </select>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(selectedCityCode))
                {
                    <div class="row mb-4" style="font-size:0.85rem; line-height:1.6;">
                        <div class="col-md-12">
                            <h6 style="color:#2B4C6F; font-size:1rem;">Informaci√≥n de la Ciudad</h6>
                            @if (selectedCity != null)
                            {
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Elevaci√≥n:</strong> @selectedCity.ElevationMeters m
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Tipo de Suelo:</strong> @GetSoilTypeDescription(selectedCity.SoilType)
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Zona Clim√°tica:</strong> @GetClimateDescription(selectedCity.ClimateZone)
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    @if (crops != null && crops.Any())
                    {
                        <h6 style="color:#2B4C6F; font-size:1rem;">Cultivos Recomendados</h6>
                        
                        <!-- Seasonal Activity Legend -->
                        <div class="table-responsive mb-3">
                            <table class="table table-sm table-bordered" style="font-size:0.75rem;">
                                <thead style="background-color:#f8f9fa;">
                                    <tr>
                                        <th>Actividad</th>
                                        <th>Descripci√≥n</th>
                                        <th>Icono</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Siembra</strong></td>
                                        <td>√âpoca ideal para plantar el cultivo</td>
                                        <td><span class="badge bg-success">üå± Siembra</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Cosecha</strong></td>
                                        <td>√âpoca de recolecci√≥n del cultivo</td>
                                        <td><span class="badge bg-warning text-dark">üåæ Cosecha</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Mantenimiento</strong></td>
                                        <td>Cuidados generales: riego, fertilizaci√≥n, control de plagas</td>
                                        <td><span class="badge bg-info text-dark">üîß Mantenimiento</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="row" style="font-size:0.85rem; line-height:1.6;">
                            @foreach (var crop in crops.Take(6)) // Show top 6 crops as cards
                            {
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100 @GetCardBorderClass(crop.CurrentSuitabilityScore)">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="card-title mb-0" style="color:#2B4C6F; font-size:0.9rem;">@crop.CropNameSpanish</h6>
                                                <span class="@GetSuitabilityDotClass(crop.SuitabilityLabel)">‚óè</span>
                                            </div>
                                            
                                            <!-- Big percentage score -->
                                            <div class="text-center mb-2">
                                                <span style="font-size:2.5rem; font-weight:bold; color:@GetScoreColor(crop.CurrentSuitabilityScore);">
                                                    @crop.CurrentSuitabilityScore%
                                                </span>
                                                <div style="font-size:0.7rem; color:#666;">
                                                    @GetSuitabilityText(crop.SuitabilityLabel)
                                                </div>
                                            </div>
                                            
                                            <!-- Seasonal activity tag -->
                                            <div class="text-center mb-2">
                                                <span class="badge @GetSeasonBadgeClass(crop.CurrentSeasonActivity)" style="font-size:0.7rem;">
                                                    @GetSeasonText(crop.CurrentSeasonActivity)
                                                </span>
                                                @if (crop.IsPrimary)
                                                {
                                                    <span class="badge bg-warning text-dark ms-1" style="font-size:0.7rem;">Principal</span>
                                                }
                                            </div>
                                            
                                            <!-- Temperature range -->
                                            <div style="font-size:0.75rem; color:#666;">
                                                <i class="bi bi-thermometer-half"></i> 
                                                @crop.OptimalTempMin¬∞C - @crop.OptimalTempMax¬∞C
                                            </div>
                                            
                                            <!-- Humidity range -->
                                            <div style="font-size:0.75rem; color:#666;">
                                                <i class="bi bi-droplet"></i> 
                                                @crop.OptimalHumidityMin% - @crop.OptimalHumidityMax%
                                            </div>
                                            
                                            <!-- Notes (truncated) -->
                                            @if (!string.IsNullOrEmpty(crop.Notes))
                                            {
                                                <div style="font-size:0.7rem; color:#888; margin-top:0.5rem;">
                                                    @(crop.Notes.Length > 60 ? crop.Notes.Substring(0, 60) + "..." : crop.Notes)
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <!-- Detailed table for remaining crops -->
                        @if (crops.Count > 6)
                        {
                            <h6 style="color:#2B4C6F; font-size:1rem; margin-top:2rem;">Otros Cultivos</h6>
                            <div class="table-responsive" style="font-size:0.85rem; line-height:1.6;">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Cultivo</th>
                                            <th>Aptitud</th>
                                            <th>Estado</th>
                                            <th>Temporada</th>
                                            <th>Temp. √ìptima</th>
                                            <th>Humedad √ìptima</th>
                                            <th>Notas</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var crop in crops.Skip(6))
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@crop.CropNameSpanish</strong>
                                                    <br><small class="text-muted">@crop.CropNameEnglish</small>
                                                </td>
                                                <td>
                                                    <span class="badge @GetSuitabilityBadgeClass(crop.CurrentSuitabilityScore)">
                                                        @crop.CurrentSuitabilityScore%
                                                    </span>
                                                    <br><small>@GetSuitabilityText(crop.SuitabilityLabel)</small>
                                                </td>
                                                <td>
                                                    @if (crop.IsPrimary)
                                                    {
                                                        <span class="badge bg-warning text-dark">Principal</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">Secundario</span>
                                                    }
                                                </td>
                                                <td>
                                                    <span class="badge @GetSeasonBadgeClass(crop.CurrentSeasonActivity)">
                                                        @GetSeasonText(crop.CurrentSeasonActivity)
                                                    </span>
                                                </td>
                                                <td>@crop.OptimalTempMin¬∞C - @crop.OptimalTempMax¬∞C</td>
                                                <td>@crop.OptimalHumidityMin% - @crop.OptimalHumidityMax%</td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(crop.Notes))
                                                    {
                                                        <small>@crop.Notes</small>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    }
                    else if (!string.IsNullOrEmpty(selectedCityCode) && crops != null)
                    {
                        <div class="alert alert-info" style="font-size:0.85rem; line-height:1.6;">
                            <i class="bi bi-info-circle"></i> No hay informaci√≥n de cultivos disponible para esta ciudad.
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-primary" style="font-size:0.85rem; line-height:1.6;">
                        <i class="bi bi-info-circle"></i> Seleccione una ciudad para ver la informaci√≥n agr√≠cola disponible.
                    </div>
                }

                @if (isLoading)
                {
                    <div class="text-center" style="font-size:0.85rem; line-height:1.6;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger" style="font-size:0.85rem; line-height:1.6;">
                        <i class="bi bi-exclamation-triangle"></i> @errorMessage
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title" style="color:#2B4C6F; font-size:1.1rem;">üìã Gu√≠a de Referencia</h5>
                <hr style="border-color:#7BCDC8; border-width:2px;"/>
                
                <!-- Soil Types Reference -->
                <h6 style="color:#2B4C6F; font-size:1rem; margin-top:1rem;">ü™® Tipos de Suelo (FAO/WRB)</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped" style="font-size:0.8rem;">
                        <thead style="background-color:#f8f9fa;">
                            <tr>
                                <th>Tipo de Suelo</th>
                                <th>Descripci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Andosol</strong></td>
                                <td>Suelos j√≥venes formados a partir de cenizas volc√°nicas; muy f√©rtiles, alta capacidad de retenci√≥n de agua.</td>
                            </tr>
                            <tr>
                                <td><strong>Fluvisol</strong></td>
                                <td>Suelos aluviales en valles y llanuras de inundaci√≥n; ricos en sedimentos fluviales, f√©rtiles pero variables.</td>
                            </tr>
                            <tr>
                                <td><strong>Acrisol</strong></td>
                                <td>Suelos √°cidos, lixiviados, comunes en climas tropicales h√∫medos; baja fertilidad natural, requieren manejo.</td>
                            </tr>
                            <tr>
                                <td><strong>Regosol</strong></td>
                                <td>Suelos poco desarrollados (j√≥venes), en √°reas de pendientes o dep√≥sitos recientes; f√©rtiles seg√∫n el material original.</td>
                            </tr>
                            <tr>
                                <td><strong>Cambisol</strong></td>
                                <td>Suelos j√≥venes de desarrollo moderado; intermedios en fertilidad, comunes en √°reas de transici√≥n.</td>
                            </tr>
                            <tr>
                                <td><strong>Leptosol</strong></td>
                                <td>Suelos muy delgados sobre roca madre, t√≠picos de laderas escarpadas; baja capacidad agr√≠cola.</td>
                            </tr>
                            <tr>
                                <td><strong>Luvisol</strong></td>
                                <td>Suelos con acumulaci√≥n de arcilla, moderadamente f√©rtiles, comunes en regiones tropicales subh√∫medas.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Climate Zones Reference -->
                <h6 style="color:#2B4C6F; font-size:1rem; margin-top:1.5rem;">üå¶Ô∏è Zonas Clim√°ticas (K√∂ppen)</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped" style="font-size:0.8rem;">
                        <thead style="background-color:#f8f9fa;">
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre</th>
                                <th>Descripci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Aw</strong></td>
                                <td>Sabana tropical</td>
                                <td>Caluroso todo el a√±o, lluvias en verano, estaci√≥n seca marcada.</td>
                            </tr>
                            <tr>
                                <td><strong>Af</strong></td>
                                <td>Ecuatorial lluvioso</td>
                                <td>Lluvia abundante todo el a√±o, sin estaci√≥n seca.</td>
                            </tr>
                            <tr>
                                <td><strong>Am</strong></td>
                                <td>Monz√≥nico tropical</td>
                                <td>Muy lluvioso, corta estaci√≥n seca, humedad alt√≠sima.</td>
                            </tr>
                            <tr>
                                <td><strong>Cwa</strong></td>
                                <td>Subtropical h√∫medo con invierno seco</td>
                                <td>Veranos c√°lidos y lluviosos, inviernos m√°s frescos y secos.</td>
                            </tr>
                            <tr>
                                <td><strong>Cwb</strong></td>
                                <td>Oce√°nico subtropical de altura</td>
                                <td>Clima templado de monta√±a: veranos frescos, inviernos secos y fr√≠os.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title" style="color:#2B4C6F; font-size:1.1rem;">Sobre el √çndice Agr√≠cola</h5>
                <hr style="border-color:#7BCDC8; border-width:2px;"/>
                <div style="font-size:0.85rem; line-height:1.6;">
                    <p>
                        Esta herramienta proporciona informaci√≥n agr√≠cola espec√≠fica para diferentes regiones de Guatemala, 
                        incluyendo datos sobre cultivos recomendados, condiciones clim√°ticas √≥ptimas, y caracter√≠sticas del suelo.
                    </p>
                    <ul>
                        <li><strong>Aptitud:</strong> Porcentaje de adecuaci√≥n del cultivo para la regi√≥n seleccionada</li>
                        <li><strong>Principal:</strong> Indica si es un cultivo econ√≥micamente importante para la regi√≥n</li>
                        <li><strong>Zonas Clim√°ticas:</strong> Altiplano (m√°s de 1800m), Tierra Media (800-1800m), Tierra Baja (menos de 800m), Costa</li>
                        <li><strong>Tipos de Suelo:</strong> Volc√°nico (tierras altas), Aluvial (valles y costas)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<CityInfo>? cities;
    private List<CropInfo>? crops;
    private string selectedCityCode = "";
    private CityInfo? selectedCity;
    private bool isLoading = false;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadCities();
    }

    private async Task LoadCities()
    {
        try
        {
            isLoading = true;
            errorMessage = "";
            
            var response = await HttpClient.GetAsync("/data-api/rest/GetCities");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<CitiesResponse>(json);
                cities = result?.Value ?? new List<CityInfo>();
            }
            else
            {
                errorMessage = "Error al cargar las ciudades.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnCityChanged(ChangeEventArgs e)
    {
        selectedCityCode = e.Value?.ToString() ?? "";
        selectedCity = cities?.FirstOrDefault(c => c.CityCode == selectedCityCode);
        
        if (!string.IsNullOrEmpty(selectedCityCode))
        {
            await LoadCrops(selectedCityCode);
        }
        else
        {
            crops = null;
        }
    }

    private async Task LoadCrops(string cityCode)
    {
        try
        {
            isLoading = true;
            errorMessage = "";
            
            var response = await HttpClient.GetAsync($"/data-api/rest/GetCropsByCity?CityCode={cityCode}");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<CropsResponse>(json);
                crops = result?.Value ?? new List<CropInfo>();
            }
            else
            {
                errorMessage = "Error al cargar los cultivos para esta ciudad.";
                crops = new List<CropInfo>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
            crops = new List<CropInfo>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetSuitabilityBadgeClass(int score)
    {
        return score switch
        {
            >= 85 => "bg-success",      // Excellent
            >= 70 => "bg-primary",      // Very Good
            >= 50 => "bg-warning",      // Fair
            >= 30 => "bg-danger",       // Poor
            _ => "bg-dark"              // Stress
        };
    }

    private string GetCardBorderClass(int score)
    {
        return score switch
        {
            >= 85 => "border-success",
            >= 70 => "border-primary", 
            >= 50 => "border-warning",
            >= 30 => "border-danger",
            _ => "border-dark"
        };
    }

    private string GetSuitabilityDotClass(string label)
    {
        return label switch
        {
            "EXCELLENT" => "text-success",
            "VERY_GOOD" => "text-primary",
            "FAIR" => "text-warning",
            "POOR" => "text-danger",
            "STRESS" => "text-dark",
            _ => "text-muted"
        };
    }

    private string GetScoreColor(int score)
    {
        return score switch
        {
            >= 85 => "#198754",  // Bootstrap success green
            >= 70 => "#0d6efd",  // Bootstrap primary blue
            >= 50 => "#fd7e14",  // Bootstrap warning orange
            >= 30 => "#dc3545",  // Bootstrap danger red
            _ => "#212529"       // Bootstrap dark
        };
    }

    private string GetSuitabilityText(string label)
    {
        return label switch
        {
            "EXCELLENT" => "Excelente",
            "VERY_GOOD" => "Muy Bueno",
            "FAIR" => "Aceptable",
            "POOR" => "Pobre",
            "STRESS" => "Estr√©s",
            _ => "Desconocido"
        };
    }

    private string GetSeasonBadgeClass(string activity)
    {
        return activity switch
        {
            "PLANTING" => "bg-success",
            "HARVEST" => "bg-warning text-dark",
            "MAINTENANCE" => "bg-secondary",
            _ => "bg-light text-dark"
        };
    }

    private string GetSeasonText(string activity)
    {
        return activity switch
        {
            "PLANTING" => "üå± Siembra",
            "HARVEST" => "üåæ Cosecha", 
            "MAINTENANCE" => "üîß Mantenimiento",
            _ => "üìÖ Variable"
        };
    }

    private string GetSeasonDisplay(string plantingMonths, string harvestMonths)
    {
        // For now, return a simple display. Could be enhanced to parse JSON and show month names
        return !string.IsNullOrEmpty(plantingMonths) ? "Variable" : "Todo el a√±o";
    }

    private string GetSoilTypeDescription(string soilType)
    {
        return soilType switch
        {
            "Andosol" => "Andosol - Suelos volc√°nicos muy f√©rtiles",
            "Fluvisol" => "Fluvisol - Suelos aluviales de valles",
            "Acrisol" => "Acrisol - Suelos √°cidos tropicales",
            "Regosol" => "Regosol - Suelos j√≥venes poco desarrollados", 
            "Cambisol" => "Cambisol - Suelos de desarrollo moderado",
            "Leptosol" => "Leptosol - Suelos delgados sobre roca",
            "Luvisol" => "Luvisol - Suelos con acumulaci√≥n de arcilla",
            _ => $"{soilType} - Tipo de suelo especializado"
        };
    }

    private string GetClimateDescription(string climateZone)
    {
        return climateZone switch
        {
            "Aw" => "Aw - Sabana tropical (lluvias estacionales)",
            "Af" => "Af - Ecuatorial lluvioso (lluvia constante)",
            "Am" => "Am - Monz√≥nico tropical (muy lluvioso)",
            "Cwa" => "Cwa - Subtropical h√∫medo (invierno seco)",
            "Cwb" => "Cwb - Oce√°nico subtropical de altura (templado de monta√±a)",
            _ => $"{climateZone} - Zona clim√°tica especializada"
        };
    }

    // Data models
    public class CitiesResponse
    {
        [JsonPropertyName("value")]
        public List<CityInfo> Value { get; set; } = new();
    }

    public class CropsResponse
    {
        [JsonPropertyName("value")]
        public List<CropInfo> Value { get; set; } = new();
    }

    public class CityInfo
    {
        [JsonPropertyName("CityCode")]
        public string CityCode { get; set; } = "";

        [JsonPropertyName("CityName")]
        public string CityName { get; set; } = "";

        [JsonPropertyName("ElevationMeters")]
        public int ElevationMeters { get; set; }

        [JsonPropertyName("SoilType")]
        public string SoilType { get; set; } = "";

        [JsonPropertyName("ClimateZone")]
        public string ClimateZone { get; set; } = "";
    }

    public class CropInfo
    {
        [JsonPropertyName("CropNameSpanish")]
        public string CropNameSpanish { get; set; } = "";

        [JsonPropertyName("CropNameEnglish")]
        public string CropNameEnglish { get; set; } = "";

        [JsonPropertyName("StaticSuitabilityScore")]
        public int StaticSuitabilityScore { get; set; }

        [JsonPropertyName("CurrentSuitabilityScore")]
        public int CurrentSuitabilityScore { get; set; }

        [JsonPropertyName("SuitabilityLabel")]
        public string SuitabilityLabel { get; set; } = "";

        [JsonPropertyName("CurrentSeasonActivity")]
        public string CurrentSeasonActivity { get; set; } = "";

        [JsonPropertyName("IsPrimary")]
        public bool IsPrimary { get; set; }

        [JsonPropertyName("OptimalTempMin")]
        public float OptimalTempMin { get; set; }

        [JsonPropertyName("OptimalTempMax")]
        public float OptimalTempMax { get; set; }

        [JsonPropertyName("OptimalHumidityMin")]
        public int OptimalHumidityMin { get; set; }

        [JsonPropertyName("OptimalHumidityMax")]
        public int OptimalHumidityMax { get; set; }

        [JsonPropertyName("PlantingMonths")]
        public string PlantingMonths { get; set; } = "";

        [JsonPropertyName("HarvestMonths")]
        public string HarvestMonths { get; set; } = "";

        [JsonPropertyName("Notes")]
        public string Notes { get; set; } = "";

        // Legacy property for backward compatibility
        [JsonPropertyName("SuitabilityScore")]
        public int SuitabilityScore 
        { 
            get => CurrentSuitabilityScore; 
            set => CurrentSuitabilityScore = value; 
        }
    }
}
